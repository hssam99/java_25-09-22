package bank;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

public class BankController implements BankProgram {
	
	List<Bank> bankList = new ArrayList<Bank>(); // 은행 리스트
	
	
	
	public void makeUserListTemp() {
		// 우리은행
		Account acc1 = new Account(bankList.get(0).getCompanyName(), "이지은", "1001", 200000);
		bankList.get(0).getCustomerList().add(acc1);
		try {
			bankList.get(0).makeAccountFile(acc1.getFileName(), acc1);
		} catch (IOException e) {
			e.printStackTrace();
		}
		
		
		Account acc2 = new Account(bankList.get(0).getCompanyName(), "장원영", "1002", 100000);
		bankList.get(0).getCustomerList().add(acc2);
		try {
			bankList.get(0).makeAccountFile(acc2.getFileName(), acc2);
		} catch (IOException e) {
			e.printStackTrace();
		}

	}
	
	
	
	@Override
	public void printMenu() {
		System.out.println("=============== MENU ===============");
		System.out.println("1. 계좌생성 | 2. 입금하기 | 3. 출금하기");
		System.out.println("4. 송금하기 | 5. 계좌정보출력하기 | 6. 종료");
		System.out.println("====================================");
	}
	
	
	// 1. 사용자 계정 생성
	@Override
	public void createAccount(Scanner sc) {
		
		int bankName = returnBankName(); // 은행 선택(선택한 은행 인덱스 리턴)
		bankList.get(bankName).addAccount(sc); // 계정 생성
		
	}

	
	// 2. 입금하기
	@Override
	public void deposit(Scanner sc) {
		int bankName = returnBankName(); // 은행 선택(선택한 은행 인덱스 리턴)
		
		System.out.print("계좌번호 입력 > ");
		String keyWord = sc.next();
		
		int index = bankList.get(bankName).findAccount(keyWord); // 검색한 계좌 인덱스 리턴
		
		
		if(index==-1) {
			System.out.println("계좌 정보가 존재하지 않습니다.");
			return;
		}
		
		Account userAccount = bankList.get(bankName).getCustomerList().get(index); // 검색한 계좌
		
		System.out.print("입금금액 > ");
		int amount = sc.nextInt();
		int balance = userAccount.getBalance() + amount; // 기존 금액 + 입력한 금액 
		userAccount.setBalance(balance); // balance 업데이트
		userAccount.saveTransactionLog(0, amount, userAccount, userAccount); // deposit code = 0
		
	}

	
	// 3. 출금하기
	@Override
	public void withdraw(Scanner sc) {
		int bankName = returnBankName(); // 은행 선택(선택한 은행 인덱스 리턴)
		
		System.out.print("계좌번호 입력 > ");
		String keyWord = sc.next();
		
		int index = bankList.get(bankName).findAccount(keyWord); // 검색한 계좌 인덱스 리턴
		
		if(index==-1) {
			System.out.println("계좌 정보가 존재하지 않습니다.");
			return;
		}
		
		Account userAccount = bankList.get(bankName).getCustomerList().get(index); // 검색한 계좌
		
		System.out.print("출금금액 > ");
		int amount = sc.nextInt();
		int balance = userAccount.getBalance() - amount; // 기존 금액 - 입력한 금액
		
		if(balance<=0) {
			System.out.println("계좌에 잔액이 부족합니다. 출금할 수 없습니다.");
			return;
		}
		
		userAccount.setBalance(balance); // balance 업데이트
		userAccount.saveTransactionLog(1, amount, userAccount, userAccount); // withdraw code = 1
		
		
	}

	
	// 4. 송금하기
	@Override
	public void transfer(Scanner sc) {
		
		// 보내는이
		System.out.println("=== 보내는이 ===");
		int senderBankName = returnBankName(); // 은행 선택(선택한 은행 인덱스 리턴)
		
		System.out.print("계좌번호 입력 > ");
		String keyWord = sc.next();
		
		int senderIndex = bankList.get(senderBankName).findAccount(keyWord); // 검색한 계좌 인덱스 리턴
		
		if(senderIndex==-1) {
			System.out.println("계좌 정보가 존재하지 않습니다.");
			return;
		}
		
		Account senderAcc = bankList.get(senderBankName).getCustomerList().get(senderIndex); // 보내는이 객체 생성
		
		
		// 받는이
		System.out.println("=== 받는이 ===");
		int receiverBankName = returnBankName(); // 은행 선택(선택한 은행 인덱스 리턴)
		
		System.out.print("계좌번호 입력 > ");
		keyWord = sc.next();
		
		int recieverIndex = bankList.get(receiverBankName).findAccount(keyWord); // 검색한 계좌 인덱스 리턴
		
		if(recieverIndex==-1) {
			System.out.println("계좌 정보가 존재하지 않습니다.");
			return;
		}
		
		Account receiverAcc = bankList.get(receiverBankName).getCustomerList().get(recieverIndex); // 받는이 객체 생성
		
		
		
		// 송금 금액 입력
		System.out.print("금액 입력 > ");
		int amount = sc.nextInt();
		
		
		// 이체 처리
		
		// 1. 송금자
		int senderBalance = senderAcc.getBalance()-amount;
		if(senderBalance<=0) {
			System.out.println("계좌에 잔액이 부족합니다. 출금할 수 없습니다.");
			return;
		}
		senderAcc.setBalance(senderBalance); // 잔액 업데이트
		senderAcc.saveTransactionLog(2, amount, senderAcc, receiverAcc); // transfer cod3 = 2 로그 기록
		
		
		
		// 2. 받는자
		int receiverBalance = receiverAcc.getBalance()+amount;
		receiverAcc.setBalance(receiverBalance); // 잔액 업데이트
		receiverAcc.saveTransactionLog(3, amount, senderAcc, receiverAcc); // 로그 기록
		
		
		System.out.println("송금을 완료했습니다.");
		
	}

	
	
	// 5. 계좌 정보 출력하기
	@Override
	public void printAccountHistory(Scanner sc) {
		
		// 은행 선택 (은행번호 리턴)
		int bankName = returnBankName();
		
		System.out.print("계좌번호 입력 > ");
		String keyWord = sc.next();
		
		// 계좌 검색
		// 존재하면 계좌 인덱스 리턴
		int index = bankList.get(bankName).findAccount(keyWord);
		
		if(index==-1) {
			System.out.println("계좌 정보가 존재하지 않습니다.");
			return;
		}
		
		Account userAccount = bankList.get(bankName).getCustomerList().get(index);
		
		try (BufferedReader br = new BufferedReader(new FileReader(userAccount.getFileName()))) {
            String line;
            while ((line = br.readLine()) != null) { // 한 줄씩 읽기
                System.out.println(line);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
	}
	
	

	@Override
	public void makeBankList() {
		bankList.add(new Bank("우리은행"));
		bankList.add(new Bank("신한은행"));
		bankList.add(new Bank("하나은행"));
	}
	
	@Override
	public void printBankList() {
		System.out.println("---은행 리스트---");
		int i = 1;
		for(Bank b : bankList) {
			System.out.println("["+i++ + "] "+b.getCompanyName());
		}
		System.out.println("--------------");
	}

	
	// 은행을 선택하면 해당 은행 인덱스 값 리턴
	public int returnBankName() {
		printBankList();
		int bankName = -1;
		do{
			try {
				System.out.print("은행 선택 > ");
				bankName = sc.nextInt()-1; // 리스트 인덱스는 사용자가 입력한 값의 -1
				
				if (bankName<0||bankName>2) {
					System.out.println("없는 옵션입니다. 다시 선택하세요.");
					bankName = -1;
					continue;
				}
				break;
			} catch (Exception e) {
				System.err.println("Err: 잘못된 값을 입력했습니다.");
				sc.nextLine();
			}
		}while(true);
		return bankName;
	}

	
	
	
	

}
